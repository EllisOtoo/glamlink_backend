generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vendor {
  id              String                @id @default(cuid())
  businessName    String
  handle          String                @unique
  status          VendorStatus          @default(DRAFT)
  contactEmail    String?
  phoneNumber     String?
  bio             String?
  locationArea    String?
  instagramHandle String?
  websiteUrl      String?
  kycSubmittedAt  DateTime?
  verifiedAt      DateTime?
  rejectionReason String?
  reviewedById    String?
  userId          String?               @unique
  user            User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  reviewedBy      User?                 @relation("VendorReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  documents       KycDocument[]
  statusHistory   VendorStatusHistory[]
  services        Service[]
  weeklyHours     WeeklyAvailability[]
  availabilityOverrides AvailabilityOverride[]
  bookings        Booking[]
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([status])
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  firebaseUid    String?    @unique
  role           UserRole   @default(CUSTOMER)
  lastSignedInAt DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  sessions       Session[]
  emailOtps      EmailOtp[]
  vendor         Vendor?
  statusEvents   VendorStatusHistory[]  @relation("VendorStatusActor")
  reviewedVendors Vendor[]              @relation("VendorReviewedBy")
  customerBookings Booking[]            @relation("CustomerBookings")
}

model EmailOtp {
  id           String   @id @default(cuid())
  email        String
  codeHash     String
  expiresAt    DateTime
  consumedAt   DateTime?
  attemptCount Int      @default(0)
  createdAt    DateTime @default(now())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([expiresAt])
  @@index([email, consumedAt])
}

model KycDocument {
  id         String   @id @default(cuid())
  vendorId   String
  vendor     Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  type       String
  fileName   String
  storageKey String
  mimeType   String?
  sizeBytes  Int?
  uploadedAt DateTime @default(now())

  @@index([vendorId])
}

model VendorStatusHistory {
  id         String        @id @default(cuid())
  vendorId   String
  vendor     Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  fromStatus VendorStatus?
  toStatus   VendorStatus
  reason     String?
  actorId    String?
  actor      User?         @relation("VendorStatusActor", fields: [actorId], references: [id], onDelete: SetNull)
  createdAt  DateTime      @default(now())

  @@index([vendorId])
  @@index([actorId])
}

model Session {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?
  lastUsedAt DateTime?
  userAgent  String?
  clientIp   String?

  @@index([userId])
  @@index([expiresAt])
}

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
}

enum VendorStatus {
  DRAFT
  PENDING_REVIEW
  VERIFIED
  REJECTED
  SUSPENDED
}

model Service {
  id              String   @id @default(cuid())
  vendorId        String
  vendor          Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  priceCents      Int
  durationMinutes Int
  bufferMinutes   Int      @default(0)
  depositPercent  Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  bookings        Booking[]

  @@index([vendorId, isActive])
}

model WeeklyAvailability {
  id          String   @id @default(cuid())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  dayOfWeek   Int
  startMinute Int
  endMinute   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([vendorId, dayOfWeek])
}

model AvailabilityOverride {
  id        String                   @id @default(cuid())
  vendorId  String
  vendor    Vendor                   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  startsAt  DateTime
  endsAt    DateTime
  type      AvailabilityOverrideType
  reason    String?
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt

  @@index([vendorId, startsAt])
}

enum AvailabilityOverrideType {
  BLOCK
  EXTEND
}

model Booking {
  id                String         @id @default(cuid())
  reference         String         @unique
  vendorId          String
  vendor            Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  serviceId         String
  service           Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  customerUserId    String?
  customer          User?          @relation("CustomerBookings", fields: [customerUserId], references: [id], onDelete: SetNull)
  customerName      String
  customerEmail     String?
  customerPhone     String?
  status            BookingStatus  @default(PENDING)
  scheduledStart    DateTime
  scheduledEnd      DateTime
  pricePesewas      Int
  depositPesewas    Int
  balancePesewas    Int
  paymentIntent     PaymentIntent?
  notes             String?
  cancelledAt       DateTime?
  completedAt       DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([vendorId, scheduledStart])
  @@index([vendorId, status])
  @@index([serviceId, scheduledStart])
  @@index([customerUserId, scheduledStart])
}

model PaymentIntent {
  id               String          @id @default(cuid())
  bookingId        String          @unique
  booking          Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  provider         PaymentProvider
  providerRef      String          @unique
  status           PaymentStatus   @default(REQUIRES_PAYMENT_METHOD)
  amountPesewas    Int
  currency         String          @default("GHS")
  metadata         Json?
  lastError        String?
  confirmedAt      DateTime?
  cancelledAt      DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
}

enum BookingStatus {
  PENDING
  AWAITING_PAYMENT
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentProvider {
  PAYSTACK
}

enum PaymentStatus {
  REQUIRES_PAYMENT_METHOD
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
}
