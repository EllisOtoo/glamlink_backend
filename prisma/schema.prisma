generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vendor {
  id              String                @id @default(cuid())
  businessName    String
  handle          String                @unique
  status          VendorStatus          @default(DRAFT)
  contactEmail    String?
  phoneNumber     String?
  bio             String?
  locationArea    String?
  instagramHandle String?
  websiteUrl      String?
  kycSubmittedAt  DateTime?
  verifiedAt      DateTime?
  rejectionReason String?
  reviewedById    String?
  userId          String?               @unique
  user            User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  reviewedBy      User?                 @relation("VendorReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  documents       KycDocument[]
  statusHistory   VendorStatusHistory[]
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([status])
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  firebaseUid    String?    @unique
  role           UserRole   @default(CUSTOMER)
  lastSignedInAt DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  sessions       Session[]
  emailOtps      EmailOtp[]
  vendor         Vendor?
  statusEvents   VendorStatusHistory[]  @relation("VendorStatusActor")
  reviewedVendors Vendor[]              @relation("VendorReviewedBy")
}

model EmailOtp {
  id           String   @id @default(cuid())
  email        String
  codeHash     String
  expiresAt    DateTime
  consumedAt   DateTime?
  attemptCount Int      @default(0)
  createdAt    DateTime @default(now())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([expiresAt])
  @@index([email, consumedAt])
}

model KycDocument {
  id         String   @id @default(cuid())
  vendorId   String
  vendor     Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  type       String
  fileName   String
  storageKey String
  mimeType   String?
  sizeBytes  Int?
  uploadedAt DateTime @default(now())

  @@index([vendorId])
}

model VendorStatusHistory {
  id         String        @id @default(cuid())
  vendorId   String
  vendor     Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  fromStatus VendorStatus?
  toStatus   VendorStatus
  reason     String?
  actorId    String?
  actor      User?         @relation("VendorStatusActor", fields: [actorId], references: [id], onDelete: SetNull)
  createdAt  DateTime      @default(now())

  @@index([vendorId])
  @@index([actorId])
}

model Session {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?
  lastUsedAt DateTime?
  userAgent  String?
  clientIp   String?

  @@index([userId])
  @@index([expiresAt])
}

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
}

enum VendorStatus {
  DRAFT
  PENDING_REVIEW
  VERIFIED
  REJECTED
  SUSPENDED
}
