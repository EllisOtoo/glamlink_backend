generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vendor {
  id                    String                 @id @default(cuid())
  businessName          String
  handle                String                 @unique
  status                VendorStatus           @default(DRAFT)
  contactEmail          String?
  phoneNumber           String?
  bio                   String?
  locationArea          String?
  instagramHandle       String?
  websiteUrl            String?
  latitude              Float?
  longitude             Float?
  serviceRadiusKm       Int?                  @default(15)
  logoStorageKey        String?
  logoVersion           Int                    @default(0)
  kycSubmittedAt        DateTime?
  verifiedAt            DateTime?
  rejectionReason       String?
  reviewedById          String?
  userId                String?                @unique
  user                  User?                  @relation(fields: [userId], references: [id], onDelete: SetNull)
  reviewedBy            User?                  @relation("VendorReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  documents             KycDocument[]
  statusHistory         VendorStatusHistory[]
  services              Service[]
  weeklyHours           WeeklyAvailability[]
  availabilityOverrides AvailabilityOverride[]
  staff                 StaffMember[]
  seats                 ServiceSeat[]
  bookings              Booking[]
  calendarEntries       BookingCalendarEntry[]
  reviews               Review[]
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  @@index([status])
}

model User {
  id               String                 @id @default(cuid())
  email            String                 @unique
  firebaseUid      String?                @unique
  role             UserRole               @default(CUSTOMER)
  lastSignedInAt   DateTime?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  sessions         Session[]
  emailOtps        EmailOtp[]
  vendor           Vendor?
  customerProfile  CustomerProfile?
  statusEvents     VendorStatusHistory[]  @relation("VendorStatusActor")
  reviewedVendors  Vendor[]               @relation("VendorReviewedBy")
  customerBookings Booking[]              @relation("CustomerBookings")
  calendarEntries  BookingCalendarEntry[] @relation("CalendarCustomerEntries")
  pushTokens       PushToken[]
  writtenReviews   Review[]
}

model EmailOtp {
  id           String    @id @default(cuid())
  email        String
  codeHash     String
  expiresAt    DateTime
  consumedAt   DateTime?
  attemptCount Int       @default(0)
  createdAt    DateTime  @default(now())
  userId       String?
  user         User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([expiresAt])
  @@index([email, consumedAt])
}

model KycDocument {
  id         String   @id @default(cuid())
  vendorId   String
  vendor     Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  type       String
  fileName   String
  storageKey String
  mimeType   String?
  sizeBytes  Int?
  uploadedAt DateTime @default(now())

  @@index([vendorId])
}

model VendorStatusHistory {
  id         String        @id @default(cuid())
  vendorId   String
  vendor     Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  fromStatus VendorStatus?
  toStatus   VendorStatus
  reason     String?
  actorId    String?
  actor      User?         @relation("VendorStatusActor", fields: [actorId], references: [id], onDelete: SetNull)
  createdAt  DateTime      @default(now())

  @@index([vendorId])
  @@index([actorId])
}

model Session {
  id         String    @id @default(cuid())
  tokenHash  String    @unique
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?
  lastUsedAt DateTime?
  userAgent  String?
  clientIp   String?

  @@index([userId])
  @@index([expiresAt])
}

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
}

enum VendorStatus {
  DRAFT
  PENDING_REVIEW
  VERIFIED
  REJECTED
  SUSPENDED
}

model Service {
  id              String                 @id @default(cuid())
  vendorId        String
  vendor          Vendor                 @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  priceCents      Int
  durationMinutes Int
  bufferMinutes   Int                    @default(0)
  depositPercent  Int?
  isActive        Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  bookings        Booking[]
  calendarEntries BookingCalendarEntry[]
  images          ServiceImage[]
  seatLinks       ServiceSeatService[]

  @@index([vendorId, isActive])
}

model ServiceImage {
  id         String   @id @default(cuid())
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  storageKey String
  caption    String?
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([serviceId])
}

model WeeklyAvailability {
  id          String   @id @default(cuid())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  dayOfWeek   Int
  startMinute Int
  endMinute   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([vendorId, dayOfWeek])
}

model AvailabilityOverride {
  id        String                   @id @default(cuid())
  vendorId  String
  vendor    Vendor                   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  startsAt  DateTime
  endsAt    DateTime
  type      AvailabilityOverrideType
  reason    String?
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt

  @@index([vendorId, startsAt])
}

enum AvailabilityOverrideType {
  BLOCK
  EXTEND
}

model Booking {
  id                 String                 @id @default(cuid())
  reference          String                 @unique
  vendorId           String
  vendor             Vendor                 @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  serviceId          String
  service            Service                @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  customerUserId     String?
  customer           User?                  @relation("CustomerBookings", fields: [customerUserId], references: [id], onDelete: SetNull)
  customerName       String
  customerEmail      String?
  customerPhone      String?
  status             BookingStatus          @default(PENDING)
  scheduledStart     DateTime
  scheduledEnd       DateTime
  pricePesewas       Int
  depositPesewas     Int
  balancePesewas     Int
  paymentIntent      PaymentIntent?
  notes              String?
  cancelledAt        DateTime?
  cancellationReason String?
  cancelledBy        BookingCancelActor?
  rescheduledAt      DateTime?
  rescheduleCount    Int                    @default(0)
  reminderSentAt     DateTime?
  completedAt        DateTime?
  seatId             String?
  seat               ServiceSeat?           @relation(fields: [seatId], references: [id], onDelete: SetNull)
  staffId            String?
  staff              StaffMember?           @relation(fields: [staffId], references: [id], onDelete: SetNull)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  calendarEntries    BookingCalendarEntry[]
  review             Review?

  @@index([vendorId, scheduledStart])
  @@index([vendorId, status])
  @@index([serviceId, scheduledStart])
  @@index([customerUserId, scheduledStart])
  @@index([seatId, scheduledStart])
  @@index([staffId, scheduledStart])
}

model PaymentIntent {
  id            String          @id @default(cuid())
  bookingId     String          @unique
  booking       Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  provider      PaymentProvider
  providerRef   String          @unique
  status        PaymentStatus   @default(REQUIRES_PAYMENT_METHOD)
  amountPesewas Int
  currency      String          @default("GHS")
  metadata      Json?
  lastError     String?
  confirmedAt   DateTime?
  cancelledAt   DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

enum BookingStatus {
  PENDING
  AWAITING_PAYMENT
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentProvider {
  PAYSTACK
}

enum PaymentStatus {
  REQUIRES_PAYMENT_METHOD
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
}

model BookingCalendarEntry {
  id             String            @id @default(cuid())
  bookingId      String
  booking        Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  ownerType      CalendarOwnerType
  vendorId       String?
  vendor         Vendor?           @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  customerUserId String?
  customer       User?             @relation("CalendarCustomerEntries", fields: [customerUserId], references: [id], onDelete: SetNull)
  serviceId      String
  service        Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  seatId         String?
  seat           ServiceSeat?      @relation(fields: [seatId], references: [id], onDelete: SetNull)
  staffId        String?
  staff          StaffMember?      @relation(fields: [staffId], references: [id], onDelete: SetNull)
  scheduledStart DateTime
  scheduledEnd   DateTime
  status         BookingStatus
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@unique([bookingId, ownerType])
  @@index([vendorId, scheduledStart])
  @@index([customerUserId, scheduledStart])
  @@index([seatId, scheduledStart])
  @@index([staffId, scheduledStart])
}

model StaffMember {
  id              String        @id @default(cuid())
  vendorId        String
  vendor          Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  name            String
  bio             String?
  avatarStorageKey String?
  specialties     String[]      @default([])
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  seats           ServiceSeat[]
  bookings        Booking[]
  calendarEntries BookingCalendarEntry[]

  @@index([vendorId, isActive])
}

model ServiceSeat {
  id              String                 @id @default(cuid())
  vendorId        String
  vendor          Vendor                 @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  label           String
  description     String?
  capacity        Int                    @default(1)
  isActive        Boolean                @default(true)
  staffId         String?
  staff           StaffMember?           @relation(fields: [staffId], references: [id], onDelete: SetNull)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  bookings        Booking[]
  calendarEntries BookingCalendarEntry[]
  services        ServiceSeatService[]

  @@index([vendorId, isActive])
  @@index([staffId])
}

model ServiceSeatService {
  serviceId String
  seatId    String
  service   Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  seat      ServiceSeat @relation(fields: [seatId], references: [id], onDelete: Cascade)

  @@id([serviceId, seatId])
  @@index([seatId])
}

enum CalendarOwnerType {
  VENDOR
  CUSTOMER
}

model PushToken {
  id               String       @id @default(cuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  token            String       @unique
  platform         PushPlatform @default(EXPO)
  deviceName       String?
  appVersion       String?
  lastRegisteredAt DateTime     @default(now())
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([userId])
}

enum PushPlatform {
  IOS
  ANDROID
  WEB
  EXPO
}

model CustomerProfile {
  userId                String  @id
  user                  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName              String?
  phoneNumber           String?
  dateOfBirth           DateTime?
  preferredPronouns     String?
  city                  String?
  country               String?
  profilePhotoStorageKey String?
  profilePhotoVersion   Int     @default(0)
  marketingOptIn        Boolean @default(false)
  smsOptIn              Boolean @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([phoneNumber])
}

enum BookingCancelActor {
  CUSTOMER
  VENDOR
  SYSTEM
}

model Review {
  id             String    @id @default(cuid())
  bookingId      String    @unique
  booking        Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vendorId       String
  vendor         Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  customerUserId String
  customer       User      @relation(fields: [customerUserId], references: [id], onDelete: Cascade)
  rating         Int
  comment        String?
  reply          String?
  repliedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([vendorId])
  @@index([customerUserId])
}

model SupplySupplier {
  id            String          @id @default(cuid())
  name          String
  contactEmail  String?
  phoneNumber   String?
  serviceAreas  String[]        @default([])
  priority      Int?
  isActive      Boolean         @default(true)
  products      SupplyProduct[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([isActive])
}

model SupplyProduct {
  id               String          @id @default(cuid())
  supplierId       String
  supplier         SupplySupplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  category         String
  name             String
  description      String?
  unit             String?
  leadTimeDays     Int?
  mediaUrl         String?
  attributes       Json?
  isActive         Boolean         @default(true)
  inStock          Boolean         @default(true)
  stockRefreshedAt DateTime?
  prices           SupplyPrice[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([supplierId, isActive])
  @@index([category, isActive])
  @@index([inStock, isActive])
}

model SupplyPrice {
  id                 String         @id @default(cuid())
  productId          String
  product            SupplyProduct  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplierCostCents  Int
  markupBasisPoints  Int
  vendorPriceCents   Int
  startsAt           DateTime       @default(now())
  endsAt             DateTime?
  createdAt          DateTime       @default(now())

  @@index([productId, startsAt])
}
